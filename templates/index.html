<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    >
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500&display=swap" rel="stylesheet">


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  </head>

  <body>
    
    <div id="chatbot-section">
      <div class="container">
        <p>
          Please read the email provided carefully and use the chatbot to help you 
          determine if the email is spam or not. This Chatbot will be used for a 
          research study; the prompts entered will be recorded and analyzed. Do not 
          enter any information you wish to keep private.
        </p>
    
        <!-- Flex container for End Session and Timer within the container for better alignment -->
        <div class="end-session-timer">
          <button id="end-session-btn">Proceed To Survey</button>
          <div id="timer">{{TIMER_LIMIT|timer_format}}</div>
        </div>
      </div>
    </div>
      
    
  
    <!-- Add tab buttons @girma_terfa -->
     <!-- 
    <div class="container" style="margin-bottom: 20px; text-align: center">
      <button class="btn btn-info" onclick="showTab('chat')">Chat</button>
      <button class="btn btn-info" onclick="showTab('email')">
        View Email
      </button>
    </div>
    -->
    {% comment %} add this two line at the start and end of the chat window
    {% if user_id_int % 2 == 1 %} 
    {% endif %} 
    {% endcomment %}
<!-- Collapsed Chat Button (Profile Picture) -->
<div id="collapsed-chat" class="chat_window collapsed" onclick="toggleChat()"></div>

<!-- Full Chat Window -->
<div id="chat" class="chat_window" style="display: none;">
<div class="top_menu" onclick="toggleChat()">
    <div class="title">Hi, Your User Id is: {{userId}}</div>
</div>

<div id="chatContent">
    <ul class="messages">
        {% for convo in convo_history %}
        <li class="message {{convo.is_bot|message_side_format}} appeared">
            <div class="avatar"></div>
            <div class="text_wrapper">
                <div class="text">{{convo.content}}</div>
            </div>
        </li>
        {% endfor %}
    </ul>
    <div class="bottom_wrapper clearfix">
        <div class="message_input_wrapper">
            <input class="message_input" placeholder="Type your message here..." />
        </div>
        <div class="send_message">
            <div class="icon">
                <img src="{{ url_for('static', filename='images/logos/send_icon.svg') }}" alt="Send Icon" />
            </div>
            <div class="text">
                <b><strong>Send</strong></b>
            </div>
        </div>
    </div>
</div>

<div class="message_template">
    <li class="message">
        <div class="avatar"></div>
        <div class="text_wrapper">
            <div class="text"></div>
        </div>
    </li>
</div>
</div>


        <!-- End Session Button -->
        <!-- End Session Button (now positioned on top left) -->
      <button id="end-session-btn" class="btn btn-danger">
          End Session
      </button>

      <!-- Gmail Email View in a Contained Box -->
    <div id="gmail-ui" class="gmail-ui-container" style="display: block;">
      <!-- Gmail Header -->
      <div class="gmail-top-bar">
        <div class="gmail-logo">
          <img src="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico" alt="Gmail Logo" class="gmail-logo-icon" />
          <span>Gmail</span>
        </div>
        <div class="gmail-search">
          <input type="text" class="gmail-search-bar" placeholder="Search mail" />
        </div>
        <div class="gmail-top-icons">
          <img src="https://ssl.gstatic.com/ui/v1/icons/mail/profile_mask2.png" alt="User Profile" class="gmail-profile-icon" />
        </div>
      </div>

      <!-- Gmail Sidebar (Fixed Position and Non-Overlapping) -->
      <div class="gmail-sidebar">
        <ul>
          <li><a href="#"><i class="fa fa-inbox"></i> Inbox</a></li>
          <li><a href="#"><i class="fa fa-star"></i> Starred</a></li>
          <li><a href="#"><i class="fa fa-clock"></i> Snoozed</a></li>
          <li><a href="#"><i class="fa fa-paper-plane"></i> Sent</a></li>
          <li><a href="#"><i class="fa fa-file"></i> Drafts</a></li>
        </ul>
      </div>

      <!--ADDED ICONS-->
      <div class="gmail-icons-left">
        <img src="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/archive_24dp.png" class="gmail-icon">
        <img src="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/report_24dp.png" class="gmail-icon">
        <img src="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/delete_24dp.png" class="gmail-icon">
        <img src="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/mark_as_unread_24dp.png" class="gmail-icon">
        <img src="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/move_to_24dp.png" class="gmail-icon">
        <img src="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/label_24dp.png" class="gmail-icon">
      </div>
      

      <!-- Gmail Content -->
      <div class="gmail-content">
        <div class="gmail-email-header">
          <h2>{{ email_subject }}</h2>
          <div class="gmail-email-sender">
            <strong>{{ email_sender }}</strong>
            <span>&lt;{{ email_sender_email }}&gt;</span>
          </div>
          <div class="gmail-recipient">
            <span>To: username@gmail.com</span> <!-- Hardcoded recipient -->
          </div>
          <div class="gmail-email-date">
            <span>Thu, 5 Oct 2024, 4:00 PM</span> <!-- Hardcoded date -->
          </div>
        </div>

        <div class="gmail-body">
          <p>{{ email_content }}</p>
        </div>

        <div class="gmail-reply-options">
          <button class="gmail-reply-btn"><i class="fa fa-reply"></i> Reply</button>
          <button class="gmail-reply-all-btn"><i class="fa fa-reply-all"></i> Reply All</button>
          <button class="gmail-forward-btn"><i class="fa fa-forward"></i> Forward</button>
        </div>
      </div>
    </div>
    
      <!-- To pass a variable in external JS -->
      <!-- No longer used, moved the usage inside python -->
      <!-- <div id="userInfo" data-userid="{{ userId }}"></div> -->

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>

    <!-- JavaScript to Switch Between Tabs @girma_terfa -->
    <script>
      function showTab(tabId) {
        // Initially hide both chat and email
        document.getElementById('chat').style.display = 'none';
        document.getElementById('gmail-ui').style.display = 'none';
      
        // Display the correct tab based on the button clicked
        if (tabId === 'chat') {
          document.getElementById('chat').style.display = 'block'; // Show chat
        } else if (tabId === 'email') {
          document.getElementById('gmail-ui').style.display = 'block'; // Show email
        }
      }                    
    </script>
    
    
    <script>
      // Set the timer to 5 minutes (300 seconds)
      let timeRemaining = {{TIMER_LIMIT}};

      // Function to start the countdown
      function startCountdown() {
          const timer = setInterval(function() {
              timeRemaining--;

              // Calculate minutes and seconds
              const minutes = Math.floor(timeRemaining / 60);
              const seconds = timeRemaining % 60;

              // Display the time in MM:SS format
              document.getElementById('timer').innerHTML = minutes + ":" + (seconds < 10 ? '0' : '') + seconds;

              // TODO Somehow sync with the server side code for exact same display across tabs/devices.

              // If time runs out, clear the timer and redirect to the login page
              if (timeRemaining <= 0) {
                  clearInterval(timer);
                  //TODO: Alert doesn't work.
                  alert("Session expired! You will be logged out.");
                  //TODO: Am pretty sure, this href, makes it that
                  // maybe instead of redirecting to /, /get makes sure python runs before exiting
                  // @Aditya (Rebooting-me)
                  
                  // window.location.href = "/get";  // Redirect to the login page

                  window.location.href = "/end-session";  // Redirect to end the session and proceed to survey
              }
          }, 1000);  // Update the timer every second (1000ms)
      }

      // Start the countdown when the page loads
      window.onload = startCountdown;
    </script>
  </body>
</html>