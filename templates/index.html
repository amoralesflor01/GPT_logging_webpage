<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
</head>

<body>


<div class="container" style="border: 1px solid black; border-radius: 10px; padding: 10px; background-color: #4e919c; margin: auto;">
    <p style="font-family: Arial; color: white;font-size: 15px">
        This Chatbot will be used for a research study, the prompts entered will be recorded and analyzed. Do not enter any information you wish to keep private.
    </p>
</div>
<p style="position: absolute;
            top: 10px;
            right: 10px;
            font-weight: bold;
            font-size: 2rem" id="timer">{{TIMER_LIMIT|timer_format}}</p>


<!-- Add tab buttons @girma_terfa -->
<div class="container" style="margin-bottom: 20px; text-align: center;">
    <button class="btn btn-info" onclick="showTab('chat')">Chat</button>
    <button class="btn btn-info" onclick="showTab('email')">View Email</button>
</div>

<!-- Chat Window -->
<div id="chat" class="chat_window">
    <div class="top_menu">
        <div class="title">Hi, Your User Id is: {{userId}}</div>
    </div>
    <ul class="messages"></ul>
    <div class="bottom_wrapper clearfix">
        <div class="message_input_wrapper">
            <input class="message_input" placeholder="Type your message here..." />
        </div>

        <div class="send_message">
            <div class="icon">
                <img src="{{ url_for('static', filename='images/logos/send_icon.svg') }}" alt="Send Icon">
            </div>
            <div class="text"><b><strong>Send</strong></b></div>
        </div>
    </div>
    <div class="message_template">
            <li class="message">
                <div class="avatar"></div>
                <div class="text_wrapper">
                    <div class="text"></div>
                </div>
            </li>
        </div>
</div>


<!-- End Session Button -->
<button
    id="end-session-btn"
    class="btn btn-danger"
    style="position: fixed; bottom: 10px; right: 10px"
    >
        End Session
</button>

<!-- Email View (shown when the "View Email" button is clicked) -->
<div id="email" style="display: none; padding: 20px; border: 1px solid black; border-radius: 10px; background-color: #f9f9f9;">
    <h3>Email Subject: {{ email_subject }}</h3>
    <div id="emailContent">
        <!-- The content of the email will be dynamically inserted here -->
        <p>{{ email_content }}</p>
    </div>
    <!--    <p><strong>Dataset:</strong> {{ dataset_name }}</p>    -->
</div>

<!-- To pass a variable in external JS -->
<div id="userInfo" data-userid="{{ userId }}"></div>
<script src="{{ url_for('static', filename='js/script.js') }}"></script>

<!-- JavaScript to Switch Between Tabs @girma_terfa -->
<script>
    function showTab(tabId) {
        // Show chat or email view based on button click
        if (tabId === 'chat') {
            document.getElementById('chat').style.display = 'block';
            document.getElementById('email').style.display = 'none';
        } else if (tabId === 'email') {
            document.getElementById('chat').style.display = 'none';
            document.getElementById('email').style.display = 'block';
        }
    }

    // Function to update email content (this can be triggered in your script.js when an email is detected)
    function updateEmailContent(emailContent) {
        document.getElementById('emailContent').innerHTML = emailContent;
    }
</script>
<script>
    // Set the timer to 5 minutes (300 seconds)
    let timeRemaining = {{TIMER_LIMIT}};

    // Function to start the countdown
    function startCountdown() {
        const timer = setInterval(function() {
            timeRemaining--;

            // Calculate minutes and seconds
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;

            // Display the time in MM:SS format
            document.getElementById('timer').innerHTML = minutes + ":" + (seconds < 10 ? '0' : '') + seconds;

            // TODO Somehow sync with the server side code for exact same display across tabs/devices.
            
            // If time runs out, clear the timer and redirect to the login page
            if (timeRemaining <= 0) {
                clearInterval(timer);
                //TODO: Alert doesn't work.
                alert("Session expired! You will be logged out.");
                //TODO: Am pretty sure, this href, makes it that
                // maybe instead of redirecting to /, /get makes sure python runs before exiting
                // @Aditya (Rebooting-me)
                window.location.href = "/get";  // Redirect to the login page
            }
        }, 1000);  // Update the timer every second (1000ms)
    }

    // Start the countdown when the page loads
    window.onload = startCountdown;
</script>

</body>
</html>